/**
 * BaasCMS core v. 1.0.0
 * Copyright (c) 2014 Artod gartod@gmail.com
 * MIT License
*/
(function(e,t,n,r,i){"use strict";e.BaasCMS=e.BaasCMS||{};var s=e.BaasCMS;s.Router=r||function(){console.error("Requires Pathjs library.")};s.Router.currentParams=s.Router.currentParams||{};s.cons={formFieldTypes:["text","number","hidden","textarea","checkbox","select","google drive image","google drive file"],categoriesSelect:["id","parent_id","name","pattern_name","count","icon","description","template","place"]};s.utils={inherit:function(e,t){var n=function(){};n.prototype=t.prototype;e.prototype=new n;e.prototype.constructor=e;e.super=t.prototype},collectDataForm:function(e){var r={};var i=new Array;e.find("input, textarea, select").each(function(){var e=n(this);if((e.is(":checkbox")||e.is(":radio"))&&!e.is(":checked")){return}var t=e.val();i.push({name:e.attr("name"),value:e.attr("type")==="number"?parseFloat(t.replace(",",".")):t})});for(var s in i){if(typeof i[s].name==="undefined"){continue}r[i[s].name]=i[s].value}return r;var r={};var i=e.serializeArray();t.each(i,function(e){r[e.name]=e.value});return r}};s.Cookie={get:function(e){var t=document.cookie.match(new RegExp("(?:^|; )"+e.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return t?decodeURIComponent(t[1]):i},set:function(e,t,n){n=n||{};var r=n.expires;if(typeof r=="number"&&r){var i=new Date;i.setTime(i.getTime()+r*1e3);r=n.expires=i}if(r&&r.toUTCString){n.expires=r.toUTCString()}t=encodeURIComponent(t);var s=e+"="+t;for(var o in n){s+="; "+o;var u=n[o];if(u!==true){s+="="+u}}document.cookie=s},del:function(e){this.set(e,null,{expires:-1})}};s.loadHomePage=function(){};s.Widget=function(){function e(r){this.opts=t.extend({elementSelector:"",template:"",templateWrap:"",autoLoad:true,cache:"yes",select:null,where:{},beforeQuery:function(){},afterQuery:function(){},beforeRender:function(){},afterRender:function(){}},r);this.$el=n();var i=this;n(function(){i.$el=n(i.opts.elementSelector);e.$els=e.$els.filter(function(){return n(this).parent().length}).add(i.$el);if(i.opts.autoLoad){i.load()}})}e.$els=n();t.extend(e.prototype,{load:function(){var e=this;this.get().done(function(t){e.render(t)})},compileTemplate:function(e,r){var i=this.opts["template"+(e?t.str.classify(e):"")];return t.template(n("#"+i).html()||r||"Need to create template with id <i>"+i+"</i>.")}});return e}();s.widgets=t.extend(s.widgets||{},{Main:function(){var e=function(e){var e=e||{};this.opts=t.extend({elementSelector:"",routes:{},categoryOpts:{},itemsOpts:{},itemOpts:{},autoLoad:true,onRoute:function(){},beforeHome:function(){},afterHome:function(){}},e);this.opts.itemsOpts["*"]=this.opts.itemsOpts["*"]||{};this.routes=t.extend({},this.opts.routes,{"#/baascms/category/:cid(/page/:page)(/sort/:sort)":this.categoryOrItems,"#/baascms/category/:cid/item/:iid":this.item});this.currentRoute=null;var r=this;this.$el=n();n(function(){r.$el=n(r.opts.elementSelector);if(r.opts.autoLoad){r.initRoutes()}})};t.extend(e.prototype,{_onRoute:function(e){s.Router.currentParams=e.params;this.opts.onRoute.call(this,e);s.Widget.$els.trigger("route",e)},_newWidgetItems:function(e,n){var r=parseInt(n["page"])||1;var i=new s.widgets.Items(t.extend({patternName:e,elementSelector:this.opts.elementSelector,autoLoad:false},this.opts.itemsOpts["*"],this.opts.itemsOpts[e]));i.opts.skip=(r-1)*i.opts.limit;if(n["sort"]){i.opts.sort=n["sort"]}t.extend(i.opts.where,{category_id:n["cid"]});return i},reload:function(){if(this.currentRoute&&typeof this.currentRoute.run==="function"){this.currentRoute.run()}},initRoutes:function(){var e=this;t.each(this.routes,function(n,r){s.Router.map(r).to(function(){e._onRoute(this);if(t.isFunction(n)){n.call(e,this.params);e.currentRoute=this}})});s.Router.root("#/");s.Router.rescue(function(){this.params=this.params||{};e._onRoute(this);e.home()});s.Router.listen()},startExpecting:function(){var e=t.uniqueId("baascms_expect_");this.$el.data("baascms-expect",e);return e},fill:function(e,t){if(this.$el.data("baascms-expect")!==e){return}this.$el.html(t)},home:function(){if(this.opts.beforeHome.call(this)===false){return false}this.startExpecting();this.$el.html(t.template(n("#template-baascms-home").html(),{}));this.opts.afterHome.call(this)},categoryOrItems:function(e){var n=e["cid"],r=this.startExpecting(),i=this;s.adapter.all("Category",{select:s.cons.categoriesSelect}).done(function(o){var u=t.findWhere(o,{id:n});if(!u){i.fill(r,"Category was not found.");return}if(!u.pattern_name){var a=new s.widgets.Category(t.extend({elementSelector:i.opts.elementSelector,where:{id:n},autoLoad:false},i.opts.categoryOpts));a.get().done(function(e){if(r!==i.$el.data("baascms-expect")){return}a.render(e)});return}var f=i._newWidgetItems(u.pattern_name,e);f.get().done(function(n){if(r!==i.$el.data("baascms-expect")){return}var s=t.extend({category:u,page:parseInt(e["page"])||1,pages:u.count?Math.ceil(u.count/(f.opts.limit||1)):1},n);f.render(s)})})},item:function(e){var n=e["cid"],r=e["iid"],i=this.startExpecting(),o=this;s.adapter.all("Category",{select:s.cons.categoriesSelect}).done(function(e){var u=t.findWhere(e,{id:n})||{};if(!u.id){o.fill(i,"Category was not found.");return}if(!u.pattern_name){o.fill(i,"There is no pattern for this category.");return}var a=new s.widgets.Item(t.extend({elementSelector:o.opts.elementSelector,patternName:u.pattern_name,where:{id:r},autoLoad:false},o.opts.itemOpts[u.pattern_name]));a.get().done(function(e){o.fill(i,a.render(e,true));a.opts.afterRender.call(a,e)})})}});return e}(),Category:function(){function e(n){this.opts=t.extend({template:"template-baascms-category",cache:"no"},n);e.super.constructor.call(this,this.opts)}s.utils.inherit(e,s.Widget);t.extend(e.prototype,{get:function(){if(this.opts.beforeQuery.call(this)===false){return}var e=this;return n.when(s.adapter.first("Category",{select:this.opts.select,where:this.opts.where,cache:this.opts.cache}),s.adapter.all("Category",{select:s.cons.categoriesSelect})).then(function(n,r){var i={category:n,children:t.where(r,{parent_id:n.id})};e.opts.afterQuery.call(this,i);return i})},render:function(e,r){if(this.opts.beforeRender.call(this,e)===false){return}var i=e.category.template?n("#"+e.category.template).html():false;var o=i?t.template(i):this.compileTemplate();var u=o({routeParams:s.Router.currentParams,opts:this.opts,data:e,category:e.category});if(r){return u}this.$el.html(u);this.opts.afterRender.call(this,e)}});return e}(),Categories:function(){function e(r){this.opts=t.extend({template:"template-baascms-categories-element",templateWrap:"template-baascms-categories-wrap",select:s.cons.categoriesSelect,where:null,onRoute:function(){}},r);e.super.constructor.call(this,this.opts);var i=this;n(function(){i.$el.on("route",function(e,t){i.opts.onRoute.call(i,t)})})}s.utils.inherit(e,s.Widget);t.extend(e.prototype,{get:function(){if(this.opts.beforeQuery.call(this)===false){return}var e={select:this.opts.select};if(this.opts.where){e.where=this.opts.where}var t=this;return s.adapter.all("Category",e).then(function(e){var n={categories:e};t.opts.afterQuery.call(t,n);return n})},render:function(e,n){if(this.opts.beforeRender.call(this,e)===false){return}var r=this.compileTemplate(),i=this.compileTemplate("wrap");var o=this;var u=function(n,a){var f="";t.each(n,function(n){var l=t.where(e.categories,{parent_id:n.id});var c=l.length?i({routeParams:s.Router.currentParams,opts:o.opts,level:a+1,htmlElements:u(l,a+1)}):"";f+=r({routeParams:s.Router.currentParams,opts:o.opts,category:n,level:a,htmlChildren:c})});return f};var a=[];t.each(e.categories,function(n){if(t.findWhere(e.categories,{id:n.parent_id})){return}a.push(n)});var f=u(a,0);if(n){return f}this.$el.html(i({routeParams:s.Router.currentParams,opts:this.opts,level:0,htmlElements:f}));this.opts.afterRender.call(this,e)}});return e}(),Item:function(){function e(n){this.opts=t.extend({patternName:"",cache:"no"},n);this.opts.template=this.opts.template||"template-baascms"+t.str.dasherize(this.opts.patternName)+"-item";e.super.constructor.call(this,this.opts)}s.utils.inherit(e,s.Widget);t.extend(e.prototype,{get:function(){if(this.opts.beforeQuery.call(this)===false){return}var e=this;return n.when(s.adapter.all("Category",{select:s.cons.categoriesSelect}),s.adapter.all("Pattern"),s.adapter.first(this.opts.patternName,{cache:this.opts.cache,select:this.opts.select,where:this.opts.where})).then(function(n,r,i){var s={category:t.findWhere(n,{id:i.category_id})||{},item:i};s.pattern=t.findWhere(r,{name:s.category.pattern_name})||{};e.opts.afterQuery.call(this,s);return s})},render:function(e,t){if(this.opts.beforeRender.call(this,e)===false){return}var r=this.compileTemplate("",n("#template-baascms-item").html());var i=r({routeParams:s.Router.currentParams,opts:this.opts,data:e,item:e.item});if(t){return i}this.$el.html(i);this.opts.afterRender.call(this,e)}});return e}(),Items:function(){function e(n){this.opts=t.extend({patternName:"",cache:"no",sort:"-createdAt",limit:20,skip:0},n);var r=t.str.dasherize(this.opts.patternName);this.opts.templateWrap=this.opts.templateWrap||"template-baascms"+r+"-items-wrap";this.opts.template=this.opts.template||"template-baascms"+r+"-items-element";e.super.constructor.call(this,this.opts)}s.utils.inherit(e,s.Widget);t.extend(e.prototype,{get:function(e){if(this.opts.beforeQuery.call(this,e)===false){return}var r=this.opts.sort,i=this;return n.when(s.adapter.all("Category",{select:s.cons.categoriesSelect}),s.adapter.all("Pattern"),s.adapter.all(this.opts.patternName,{cache:this.opts.cache,select:this.opts.select,where:this.opts.where,limit:this.opts.limit,skip:this.opts.skip,order:r})).then(function(e,n,r){var s={items:r,categories:e,pattern:t.findWhere(n,{name:i.opts.patternName})||{}};i.opts.afterQuery.call(i,s);return s})},render:function(e,r){if(this.opts.beforeRender.call(this,e)===false){return}var i=this;var o=this.compileTemplate("",n("#template-baascms-items-element").html()),u=this.compileTemplate("wrap",n("#template-baascms-items-wrap").html()),a="";t.each(e.items,function(t){a+=o({routeParams:s.Router.currentParams,opts:i.opts,data:e,item:t})});if(r==="el"){return a}var f=u({routeParams:s.Router.currentParams,opts:this.opts,data:e,htmlElements:a});if(r){return f}this.$el.html(f);this.opts.afterRender.call(this,e)}});return e}(),Breadcrumbs:function(){function e(r){this.opts=t.extend({elementSelector:"",template:"template-baascms-breadcrumbs-element",templateWrap:"template-baascms-breadcrumbs-wrap"},r);var i=this;e.super.constructor.call(this,this.opts);var i=this;n(function(){i.$el.on("route",function(e,t){i.load()})})}s.utils.inherit(e,s.Widget);t.extend(e.prototype,{get:function(){var e=this;return s.adapter.all("Category",{select:s.cons.categoriesSelect}).then(function(t){var n={categories:t};e.opts.afterQuery.call(e,n);return n})},render:function(e){if(this.opts.beforeRender.call(this,e)===false){return}var n=this,r=[];var i=function(n){if(!n){return}r.push(n);i(t.findWhere(e.categories,{id:n.parent_id}))};i(t.findWhere(e.categories,{id:s.Router.currentParams["cid"]}));r.reverse();var o=this.compileTemplate("wrap"),u=this.compileTemplate(),a="";t.each(r,function(e){a+=u({routeParams:s.Router.currentParams,opts:n.opts,category:e})});this.$el.html(o({routeParams:s.Router.currentParams,opts:this.opts,htmlElements:a}));this.opts.afterRender.call(this,e)}});return e}()});s.adapters=s.adapters||{};s.Adapter=function(){function r(e,n){this.opts=t.extend({cmsOpts:{},onStart:function(){},onComplete:function(){},onError:function(){}},n);this._cache={};this._countCurrentQueries=0;this.busy=false;this._concurrents={};if(typeof e==="function"){t.extend(this,new e(n.cmsOpts))}}var e=function(){console.error("Adapter does not support this method.")};r.prototype={_query:e,_count:e,_save:e,_del:e,onStart:function(){this._countCurrentQueries++;this.busy=true;var e=t.uniqueId("baascms_query_");this.opts.onStart(e);return e},onComplete:function(e){this._countCurrentQueries--;this.opts.onComplete(e);var t=this;setTimeout(function(){if(t._countCurrentQueries===0){t.busy=false}},1)},query:function(e,r,i){var s=t.isString(r)?r:"",i=t.isObject(r)?r:i||{},o=n.Deferred(),u="query_"+s+"_"+JSON.stringify(i),a=e+"_"+u,f=this;if(i.cache==="no"||!this._cache[e]||t.isUndefined(this._cache[e][u])){if(this._concurrents[a]){return this._concurrents[a].promise()}this._concurrents[a]=o;var l=this.onStart();var c=i.count?this._count(e,i,o):this._query(e,s,i,o);c.done(function(t){f._cache[e]=f._cache[e]||{};f._cache[e][u]=JSON.stringify(t)}).fail(function(t){f.opts.onError(e,"query",t)}).always(function(){delete f._concurrents[a];f.onComplete(l)})}else{o.resolve(JSON.parse(this._cache[e][u]))}return o.promise()},getById:function(e,t,n){var n=n||{};n.first=true;return this.query(e,t,n)},first:function(e,t){var t=t||{};t.first=true;return this.query(e,t)},all:function(e,t){return this.query(e,t)},count:function(e,t){var t=t||{};t.count=true;return this.query(e,t)},save:function(e,t){var r=n.Deferred(),t=t||{},i=this;var s=this.onStart();return this._save(e,t,r).done(function(t){delete i._cache[e]}).fail(function(t){i.opts.onError(e,"save",t)}).always(function(){i.onComplete(s)})},del:function(e,r){var r=r||"",i=n.Deferred(),s=this;r=t.isArray(r)?r:[r];var o=this.onStart();return this._del(e,r,i).done(function(){delete s._cache[e]}).fail(function(t){s.opts.onError(e,"delete",t)}).always(function(){s.onComplete(o)})}};return r}();s.message=function(e,r,i){var s=n("#baascms-messages"),o=t.template(n("#template-baascms-message").html()||"");if(r==="danger"){console.error(e)}s.fadeIn().append(o({message:e,type:r}));var u=s.children().last();setTimeout(function(){u.fadeOut(function(){n(this).remove();if(!s.children().length){s.hide()}})},i||3e3)};s.inited=s.inited||false;s.init=function(e){s.opts=t.extend({baas:"Parse",onError:function(e,t,n){s.message("Error "+t+" "+e+": "+n.message,"danger")},loaderDelay:300},e);var r=0,i=[],o=n();n(function(){o=n("#baascms-loader")});s.adapter=new s.Adapter(s.adapters[s.opts.baas],{cmsOpts:s.opts,onError:function(e,t,n){s.opts.onError(e,t,n)},onStart:function(e){i[e]=setTimeout(function(){i[e]=0;r++;o.show()},s.opts.loaderDelay)},onComplete:function(e){clearTimeout(i[e]);if(i[e]===0){r--}delete i[e];if(r<=0){o.hide()}}});s.inited=true}})(window,window._,window.jQuery,window.Path)